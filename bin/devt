#!/bin/sh

set -o errexit -o pipefail -o nounset -o xtrace

host=${1:-rravi-1}

if [ -z "$SSH_AUTH_SOCK" ]; then
    eval `ssh-agent -s`
    ssh-add $HOME/.ssh/id_rsa
fi

priv_key=$HOME/.ssh/id_rsa
if [ -f "$priv_key" ]; then
    if ! ssh-add -L >/dev/null 2>&1; then
        ssh-add "$priv_key"
    fi
fi

forward_args="-o ExitOnForwardFailure=yes -D 50001 -R 2489:localhost:2489"
forward_args="$forward_args -o ExitOnForwardFailure=yes"

while true; do
    ret=0
    ssh -t $forward_args $host "tmux attach -d || tmux new-session -s dev" || ret=$?
    if [ "$ret" -ne 255 ]; then #  255 means timeout. happens when laptop is closed, disconnected from network etc
        #break
        exit 0
    fi

    # force release remote forwarded ports from prev sessions so that we can use them
    echo "got exit code ${ret} from ssh. killing sshd on the server to release ports"
    ssh $host -- "tmux detach-client; pkill --signal TERM --oldest sshd --uid \$USER" > /dev/null 2>&1 || true
    #ssh -t $forward_args $host "tmux attach -d || tmux new-session -s dev" || ret=$?
done
